name: Swap Deployment Slots

on:
  workflow_dispatch:
    inputs:
      from_slot:
        description: 'Slot to swap from'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - testing
      to_slot:
        description: 'Slot to swap to'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - testing
          - production


jobs:
  swap-slots:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Display Swap Details
      run: |
        VERSION=$(node -p "require('./package.json').version")
        SWAP_DATE=$(date '+%Y-%m-%d %H:%M:%S')
        echo "## ðŸ”„ Slot Swap Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Application Name | jpappdemo |" >> $GITHUB_STEP_SUMMARY
        echo "| Swap From Slot | ${{ inputs.from_slot }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Swap To Slot | ${{ inputs.to_slot }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Initiated by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Run ID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Run Number | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Artifact Version | $VERSION |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $SWAP_DATE |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Summary" >> $GITHUB_STEP_SUMMARY
        echo "Swapping ${{ inputs.from_slot }} slot to ${{ inputs.to_slot }} slot for jpappdemo application." >> $GITHUB_STEP_SUMMARY

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          }

    - name: Swap slots from ${{ inputs.from_slot }} to ${{ inputs.to_slot }}
      run: |
        az webapp deployment slot swap --name jpappdemo --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} --slot ${{ inputs.from_slot }} --target-slot ${{ inputs.to_slot }}