name: Build and Deploy to Azure Web App

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Display Run and Version Details
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "## ðŸš€ Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Run ID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Run Number | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit SHA | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch/Ref | ${{ github.ref }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Trigger Event | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| App Version | $VERSION |" >> $GITHUB_STEP_SUMMARY
        echo "| Repository | ${{ github.repository }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Summary" >> $GITHUB_STEP_SUMMARY
        echo "This workflow deploys the Node.js application (v$VERSION) to Azure Web App 'jpappdemo'." >> $GITHUB_STEP_SUMMARY

    - name: Build (if needed)
      run: npm run build || echo "No build script found"

    - name: Login to Azure
      uses: azure/login@v1
      id: azure_login
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          }
      continue-on-error: false

    # - name: Deploy to Azure Web App
    #   uses: azure/webapps-deploy@v2
    #   id: deploy_azure_web
    #   if: steps.azure_login.outcome == 'success'
    #   with:
    #     app-name: 'jpappdemo' 
    #     package: .


    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      id: deploy_azure_web
      if: steps.azure_login.outcome == 'success'
      with:
        app-name: 'jpappdemo'
        slot-name: 'staging'
        package: .
    
