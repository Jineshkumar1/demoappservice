name: Swap Deployment Slots

on:
  workflow_dispatch:


jobs:
  swap-slots:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Display Swap Details
      run: |
        VERSION=$(node -p "require('./package.json').version")
        SWAP_DATE=$(date '+%Y-%m-%d %H:%M:%S')
        echo "## ðŸ”„ Slot Swap Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Application Name | jpappdemo |" >> $GITHUB_STEP_SUMMARY
        echo "| Swap From Slot | staging |" >> $GITHUB_STEP_SUMMARY
        echo "| Swap To Slot | production (main) |" >> $GITHUB_STEP_SUMMARY
        echo "| Initiated by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Run ID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Run Number | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Artifact Version | $VERSION |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $SWAP_DATE |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Summary" >> $GITHUB_STEP_SUMMARY
        echo "Swapping staging slot to production (main) slot for jpappdemo application." >> $GITHUB_STEP_SUMMARY

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          }

    - name: Swap staging to production (main)
      run: |
        az webapp deployment slot swap --name jpappdemo --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} --slot staging